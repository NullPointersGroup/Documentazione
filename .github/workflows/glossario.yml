name: Aggiorna Glossario su feature

on:
  push:
    branches:
      - 'feature/*'

jobs:
  update-glossario:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # necessario per usare git diff con commit precedenti

      - name: Installa Lua
        run: |
          sudo apt-get update
          sudo apt-get install -y lua5.3

      - name: Controlla modifiche Glossario e genera HTML
        run: |
          if echo "$DIFF_FILES" | grep -qE "src/(RTB|PB)/Documenti Interni/Glossario/"; then
            echo "Glossario modificato, eseguo parser"
            lua .github/workflows/glossario_parser.lua
          else
            echo "Nessuna modifica in Glossario, skip"
          fi


      - name: Commit e Push Glossario aggiornato
        run: |
          git config --global user.name "GitHub App"
          git config --global user.email "noreply@github.com"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git add src/RTB/Documenti\ Interni/Glossario/content/letters/*.tex
          git add src/PB/Documenti\ Interni/Glossario/content/letters/*.tex
          git add website/glossario/glossario/*.html
          git commit -m "Auto: Glossario aggiornato e HTML rigenerato" || exit 0
          git push origin $GITHUB_REF_NAME